# Steps for Reproducing Results

## Prerequisites

1. GPU with compute capability `sm8.6`. Threads per block and value per thread
   in our algorithms are tuned towards `sm8.6`, and a different capability
   would use default parameters, leading to deteriorated performance.
2. A recent enough CUDA toolkit version (for flags like `--extended-lambda`).
3. A CPU with AVX-256 for the special instructions in WAH CPU and Roaring.
4. Many `.c` file here contain UNIX syscalls, so no Windows.

Notes:  
- MeRLE does not depend on the git submodule `teb`. Rather, in the bitmap
  collection experiment, MeRLE uses the testing data provided by `teb`.
  Therefore do not initialize git submodule unless you'd like to generate
  testing data yourself.
- The `moderngpu` directory contains an heavily and *intrusively* customized
  version of the now-dead `moderngpu` library. It has too much MeRLE specific
  modifications to be included as a submodule.

## Run with Pre-generated Bit Vectors

Build and run programs to generate raw result first, then reproduce images
using the notebook `res/drawFigs.ipynb`. Various commands must be run for
different experiments, but start by building first:

```sh
# clone and cd to MeRLE directory before running these
cmake -S . -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DCMAKE_BUILD_TYPE=Release
cmake --build build
```

### SSB & TPC-H

Bit vectors for the datasets (SSB, TPC-H and Bitmap Collection) are uploaded to
GitHub Release. Download (<200M) and extract it into MeRLE root directory. For
SSB and TPC-H, after extracting data, simply run `build/wahProfileGPU` with no
arguments.

```sh
# suppose data are downloaded to ~/Download.
# cd to MeRLE directory before running these
zstd -d ~/Download/dataForReproduce.tar.zst
tar xvf ~/Download/dataForReproduce.tar
build/wahProfileGPU
```

We do not automatically parse its output. You have to manually type its output
into the `df` variable into the first two cells of `res/drawFigs.ipynb` to
reproduce figures with your results.

### Synthetic Data

Nothing has to be done. `res/drawFigs.ipynb` contains cells that run compiled
program on synthetic data.

### Bitmap Collection

We provide a wrapper script for running bitmap collection:
`./benchCollection.sh`. Run it with no arguments. Note that, to verify
correctness and compare between approaches, this benchmark does huge amounts of
extra work. Expect near an hour of running time.

At the bottom of the script there are some commands rename produced results
into those accepted in `res/wahDrawFigs.ipynb`. AFAIK the `rename` package in
different distributions have various types of syntaxes so the script likely
fails. If so rename result file manually.

After doing all of these, run `res/drawFigs.ipynb` from start to finish (around
a minute of running time). `res/images` now contains reproduced results for
visualization.

## Generate Bit Vectors Yourself

While we promise that the tarball in GitHub Release is genuinely generated from
SSB / TPC-H / bitmap collections, doubtful reproducer could generate his own
from scratch rather than downloading our pre-generated bit vectors.

### Bitmap Collection

The wrapper script also handles generating from raw bitmap collection array in
the `teb` directory. Delete everything but `wahData/st`, run `git submodule
init` then run the wrapper script `benchCollection.sh` as usual. A long and
messy output from this wrapper indicates newly generated data being used.

### SSB / TPC-H

Generating bit vectors from these is more involved, requiring at least 45GB of
disk space (25 if tables are deleted immediately), 10GB of memory and several
minutes of running time (cause the generation process is naively implemented lol).

1. Download the table generation utility from SSB (`ssb-dbgen`)
2. Make all and run `./dbgen -s 20 -T a`
3. Place `res/stPrep.ipynb` and the generated `*.tbl` into a same directory
4. Run the first half of `stPrep.ipynb` (the latter half is for TPC-H)
5. Convert SSB Q1.2 integer lists generated by `stPrep.ipynb` into WAH bit
   vectors with `build/wahConv arrToWah --inFmt "s/s12l%zu.txt" --outFmt
   "wahData/st/-12l%zu.wah" --nFile 3`
6. Repeat step 5 for remaining 4 SSB datasets. Note that `nFile` may differ.
   Replace `12` to query number in `outFmt`.
7. Repeat step 1-6 for TPC-H. The next half of `stPrep.ipynb` shall be used.
   Remove the `-` in `outFmt`.

If everything was right, `ls wahData/st` should show these:

```
-12l0.wah  -13l0.wah  -23l0.wah  -34l4.wah  -41l0.wah  6l2.wah
12l0.wah   -13l1.wah  -23l1.wah  3l0.wah    -41l1.wah
-12l1.wah  -13l2.wah  -34l0.wah  3l1.wah    -41l2.wah
12l1.wah   17l0.wah   -34l1.wah  3l2.wah    -41l3.wah
-12l2.wah  17l1.wah   -34l2.wah  3l3.wah    6l0.wah
12l2.wah   17l2.wah   -34l3.wah  3l4.wah    6l1.wah
```

